# 仙侠传 (XXZ) - 游戏设计方案

> **目的**：描述游戏功能设计
>
> **技术架构**：详见 `arch.md`
>
> **开发进度**：详见 `xxz/PROGRESS.md`

---

## 项目目标

- 全新代码实现，不保留历史代码
- 兼容原版 SDB 配置数据
- 协议全新设计（不兼容原版客户端）
- 高安全性（AES+ECDH 加密，防脱机外挂）

---

## 服务功能清单

### BalanceServer

> 负载均衡服务器：将客户端分配到最优 GateServer

| 功能 | 说明 |
|------|------|
| Gate 心跳接收 | 接收 GateServer 的 UDP 心跳消息 |
| Gate 列表维护 | 维护 Gate 的 IP/端口/在线人数 |
| 负载均衡算法 | 选择最少连接数的 Gate |
| 客户端重定向 | 指引客户端连接 Gate |
| 心跳超时检测 | 5秒无心跳标记 Gate 不可用 |

---

### GateServer

> 网关服务器：管理客户端连接，转发消息（纯转发，不处理业务逻辑）

| 功能 | 说明 |
|------|------|
| 客户端连接管理 | 管理客户端 TCP 连接 |
| 消息路由转发 | 转发到 GameServer/DBServer/LoginServer |
| Balance 心跳 | 与 BalanceServer 保持 UDP 心跳 |
| 加密解密 | AES+ECDH 协议加解密 |
| 限流防刷 | 消息频率限制、防恶意连接 |
| 连接清理 | 清理无玩家/超时连接 |

---

### LoginServer

> 账户服务器：提供账户验证和管理

| 功能 | 说明 |
|------|------|
| 密码验证 | 账户登录验证 |
| 账户查询 | 查询账户信息和角色列表 |
| 账户创建 | 注册新账户 |
| 密码修改 | 修改账户密码 |
| 密码找回 | 密码重置功能 |
| 封禁检查 | 账户封禁状态验证 |
| 登录日志 | 记录登录时间、IP |

---

### DBServer

> 角色数据库服务器：提供角色数据持久化

| 功能 | 说明 |
|------|------|
| 角色 CRUD | 角色数据增删改查 |
| 角色改名 | 角色名称修改 |
| 角色锁定 | 防止同一角色多处登录 |
| 物品/技能/热键/任务 | 角色相关数据 CRUD |
| 仓库数据 | 仓库物品存取 |
| 好友/公会数据 | 社交关系持久化 |
| 邮件/拍卖数据 | 扩展数据持久化 |
| 自动备份 | 定期备份数据库 |

---

### GameServer

> 游戏逻辑服务器：处理游戏核心逻辑

| 模块 | 说明 |
|------|------|
| 角色对象 | 玩家对象管理、宏检测 |
| 怪物系统 | 怪物生成/AI/战斗/掉落 |
| NPC 系统 | 对话、商店、任务触发 |
| 门派系统 | 门派创建/管理/战争 |
| 技能系统 | 技能释放/伤害计算 |
| 物品系统 | 物品配置/拾取逻辑 |
| 魔法系统 | 魔法配置/效果 |
| 地图系统 | 地图加载/碰撞检测 |
| 传送系统 | 传送门逻辑 |
| 动态对象 | 机关/宝箱等 |
| 区域管理 | 特殊区域属性 |
| 牢狱系统 | 囚禁玩家机制 |
| 聊天系统 | 普通/私聊/门派/世界聊天 |
| 交易系统 | 玩家间物品/金币交易 |
| 仓库系统 | NPC 仓库存取 |
| PK 系统 | Ctrl+双击攻击玩家 |
| 配置加载 | 从 SDB 文件加载配置 |
| 拍卖系统 | 上架/搜索/购买/取消 |
| 邮件系统 | 发送邮件/附件物品/金币 |
| 结婚系统 | 求婚/婚礼/离婚 |
| 任务系统 | 主线/支线任务、进度追踪 |
| 队伍系统 | 组队/队长/经验分配 |
| 好友系统 | 好友列表/在线通知 |
| 排行榜 | 内力榜/声望榜/天赋榜/门派榜 |
| Lua 脚本 | NPC 对话/任务/自定义逻辑 |
| BUFF 系统 | 增益/减益效果/叠加 |
| 矿物系统 | 挖矿/矿物配置 |
| 天赋系统 | 天赋等级/升级配置 |
| 合成系统 | 材料合成/配方 |
| 远程管理 | GM 远程监控/命令 |

---

### Client

> 游戏客户端：负责渲染、UI 交互、网络通信

| 模块 | 说明 |
|------|------|
| 登录界面 | 账号登录、服务器选择、新用户注册 |
| 角色选择 | 角色选择/创建/删除界面 |
| 主窗口 | DirectX 渲染循环、消息分发 |
| 角色对象 | 角色状态、动画帧 |
| 背景渲染 | 地图背景渲染、滚动 |
| 地图系统 | 地图瓦片、碰撞检测 |
| 魔法特效 | 飞行魔法、特效动画 |
| 底部 UI | 技能栏、内功条、外功条、武功条、活力条 |
| 属性界面 | 角色属性/装备/技能面板 |
| 交易/仓库 | 玩家交易、仓库存取 |
| 网络通信 | TCP 连接管理、数据包收发 |
| 音效系统 | 背景音乐/效果音播放 |
| 自动寻路 | A* 寻路算法、自动移动 |
| 热键系统 | 全局热键注册 |
| 多分辨率 | 800×600 / 1024×768 |
| BUFF 面板 | 玩家/怪物 BUFF 状态显示 |
| 排行榜 | 各类排行榜展示 |
| 商城界面 | 元宝商城购买 |
| 公会界面 | 门派管理、成员列表 |
| 好友系统 | 好友列表/在线状态 |
| 任务面板 | 任务追踪、进度显示 |
| 迷你地图 | 区域小地图 |
| 物品升级 | 装备强化界面 |
| NPC 交易 | NPC 商店买卖 |
| 聊天历史 | 聊天记录查看 |
| 喇叭喊话 | 全服喊话功能 |

---

## 项目结构

```
xxz/
├── src/
│   ├── Common/                    # 公共模块
│   │   ├── Protocol/              # 网络协议定义
│   │   ├── GameTypes/             # 游戏类型定义
│   │   ├── Utils/                 # 公共工具类
│   │   ├── Crypto/                # AES+ECDH 加密模块
│   │   └── LuaBinding/            # Lua 绑定
│   ├── Server/
│   │   ├── BalanceServer/
│   │   ├── GateServer/
│   │   ├── LoginServer/
│   │   ├── DBServer/
│   │   └── GameServer/
│   │       └── Systems/           # 游戏系统模块
│   └── Client/
│       ├── Core/
│       ├── Render/                # DirectX 11 渲染
│       ├── UI/
│       └── Plugins/               # Lua 插件
├── build/                         # 编译输出
├── intermediate/                  # 编译中间产物
└── tools/                         # 开发/运维工具
```
